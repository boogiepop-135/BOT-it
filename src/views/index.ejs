<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>WhatsBot IT</title>
    <link rel="icon" href="/public/favicon.png">
</head>

<body>
    <div align="center">
        <h3>游뱄 WhatsBot IT Ready!</h3>
        <p>
            <img src="/public/botavatar.gif" alt="WhatsBot IT" width="300" height="300" />
        </p>
        <p>Agente de Ventas Inteligente de San Cosme IT</p>
        <div id="health">
            <table border="1" cellspacing="0" cellpadding="5" align="center" width="50%">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr align="center">
                        <td>App state</td>
                        <td><span id="status">Loading...</span></td>
                    </tr>
                    <tr align="center">
                        <td>QR Scanned</td>
                        <td><span id="qrScanned">Loading...</span></td>
                    </tr>
                    <tr align="center">
                        <td>Bot Contact</td>
                        <td><span id="botContact">Loading...</span></td>
                    </tr>
                    <tr align="center">
                        <td>Bot Push Name</td>
                        <td><span id="botPushName">Loading...</span></td>
                    </tr>
                    <tr align="center">
                        <td>Bot Platform</td>
                        <td><span id="botPlatform">Loading...</span></td>
                    </tr>
                    <tr align="center">
                        <td>Uptime</td>
                        <td><span id="uptime">Loading...</span></td>
                    </tr>
                    <tr align="center">
                        <td>Version</td>
                        <td><span id="version">Loading...</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <script>
            // API Base URL Configuration
            const API_BASE_URL = 'https://bot-it-production.up.railway.app';
            function apiUrl(path) {
              if (path.startsWith('http://') || path.startsWith('https://')) return path;
              if (path.startsWith('/')) return API_BASE_URL + path;
              return API_BASE_URL + '/' + path;
            }
            
            let lastStatus = null;
            let lastQrScanned = null;
            
            // Funci칩n para actualizar el estado solo cuando hay cambios
            function updateHealthStatus(data) {
                const statusChanged = lastStatus !== data.status;
                const qrScannedChanged = lastQrScanned !== data.qrScanned;
                
                if (statusChanged || qrScannedChanged || !lastStatus) {
                    if (!data.qrScanned) {
                        window.location.href = '/qr';
                        return;
                    }

                    if (statusChanged || !lastStatus) {
                        document.getElementById('status').innerHTML = data.status;
                        if (data.status === 'healthy') {
                            document.getElementById('status').style.color = 'green';
                        } else {
                            document.getElementById('status').style.color = 'red';
                        }
                    }
                    
                    if (qrScannedChanged || !lastQrScanned) {
                        document.getElementById('qrScanned').innerHTML = data.qrScanned;
                    }
                    
                    lastStatus = data.status;
                    lastQrScanned = data.qrScanned;
                }

                // Actualizar siempre estos campos ya que cambian con el tiempo
                const botContact = data.botContact || '';
                const currentBotContact = document.getElementById('botContact').innerHTML;
                if (currentBotContact !== botContact) {
                    document.getElementById('botContact').innerHTML = botContact;
                }
                
                const botPushName = data.botPushName || '';
                const currentBotPushName = document.getElementById('botPushName').innerHTML;
                if (currentBotPushName !== botPushName) {
                    document.getElementById('botPushName').innerHTML = botPushName;
                }
                
                const botPlatform = data.botPlatform || '';
                const currentBotPlatform = document.getElementById('botPlatform').innerHTML;
                if (currentBotPlatform !== botPlatform) {
                    document.getElementById('botPlatform').innerHTML = botPlatform;
                }
                
                document.getElementById('uptime').innerHTML = Math.floor(data.uptime || 0) + 's';
                document.getElementById('version').innerHTML = data.version || '';
            }
            
            // Polling m치s inteligente: m치s frecuente si no est치 healthy, menos frecuente si est치 healthy
            let pollInterval = 3000; // 3 segundos por defecto
            
            function pollHealth() {
                fetch(apiUrl('/health'))
                    .then(response => response.json())
                    .then(data => {
                        updateHealthStatus(data);
                        
                        // Ajustar intervalo basado en el estado
                        // Si est치 healthy, poll cada 5 segundos, si no, cada 2 segundos
                        const newInterval = data.status === 'healthy' ? 5000 : 2000;
                        if (newInterval !== pollInterval) {
                            pollInterval = newInterval;
                            clearInterval(healthPollInterval);
                            healthPollInterval = setInterval(pollHealth, pollInterval);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching health status:', error);
                        // En caso de error, intentar m치s frecuentemente
                        pollInterval = 2000;
                        clearInterval(healthPollInterval);
                        healthPollInterval = setInterval(pollHealth, pollInterval);
                    });
            }
            
            // Iniciar polling inmediatamente
            pollHealth();
            
            // Configurar intervalo inicial
            let healthPollInterval = setInterval(pollHealth, pollInterval);
        </script>
    </div>
</body>

</html>